# ZKTeco Attendance Listener

โปรแกรมสำหรับดึงข้อมูลเวลาเข้า-ออกงานจากเครื่องสแกนนิ้ว/ใบหน้า ZKTeco แบบ Real-time และบันทึกลงฐานข้อมูล SQL Server โดยอัตโนมัติ

## รายละเอียดการทำงาน

### 1. การเชื่อมต่อและดึงข้อมูล
- ดึงรายชื่อเครื่องสแกน (Device) จากฐานข้อมูลเพื่อเตรียมเชื่อมต่อ
- ใช้ระบบ **Live Capture** เพื่อดึงข้อมูลการสแกนทันทีที่มีเหตุการณ์เกิดขึ้น (ไม่ต้องรอ Pull ข้อมูล)
- รองรับการทำงานแบบ Multi-threading โดยแยก 1 Thread ต่อ 1 เครื่องสแกน

### 2. การจัดการรหัสพนักงาน (Employee ID)
- มีระบบ Normalize ID โดยจะเติมเลข 0 ด้านหน้าให้ครบ 5 หลักเสมอ (เช่น `5233` -> `05233`) เพื่อความสม่ำเสมอของข้อมูล

### 3. เงื่อนไขการบันทึกข้อมูล (Shift-based Logic)
ระบบจะตรวจสอบกะงานของพนักงานจากตาราง `[db_pfpdashboard].[dbo].[VListPeriodEmployee]` เพื่อเลือกว่าจะบันทึกเป็นเวลาเข้าหรือออกงาน:

1. **การค้นหากะงาน**: 
   - ค้นหากะงานจาก `EmpId` และ `DatePeriod` (วันนี้และเมื่อวาน)
   - เลือกกะงานที่ช่วงเวลาครอบคลุมเวลาที่แสกนจริง (รองรับกะข้ามคืน)
   - รองรับกรณีพนักงานมาสาย (เช่น มาเที่ยงหรือบ่าย) หรือกลับก่อนเวลา

2. **เกณฑ์การตัดสินใจ (Upsert)**:

| กรณี | เงื่อนไข | การดำเนินการ |
| :--- | :--- | :--- |
| **บันทึกเวลาเข้า (Scan In)** | ยังไม่พบรายการบันทึกเวลาในช่วงกะงานนั้นๆ | **INSERT** เป็นแถวใหม่ (บันทึก `TimeIn`) |
| **บันทึกเวลาออก (Scan Out)** | พบรายการบันทึกเวลา (`TimeIn`) ของกะงานนั้นแล้ว | **UPDATE** `TimeOut` ในแถวเดิม |
| **แก้ไขเวลาออก (Update Last Out)** | มีการสแกนซ้ำภายใน 1 ชั่วโมงหลังจากสแกนออกล่าสุด | **UPDATE** `TimeOut` ใหม่ทับเวลาเดิม |
| **ป้องกันสแกนซ้ำ (Threshold)** | มีการสแกนภายใน 10 นาทีหลังจากสแกนครั้งแรกของกะ | **IGNORE** ไม่บันทึกข้อมูล |

### 4. การจัดการเวลา
- รองรับการตั้งค่า `ATTENDANCE_TZ_OFFSET` ผ่าน Environment Variable (เช่น ตั้งเป็น 7 สำหรับเวลาประเทศไทย UTC+7)

## วิธีการใช้งาน
1. ตั้งค่า Environment Variables ในไฟล์ `.env` (Server, Database, User, Password)
2. ติดตั้ง Dependency: `pip install -r requirements.txt`
3. รันโปรแกรม: `python zkteco_listener.py`
