# ZKTeco Attendance Listener

โปรแกรมสำหรับดึงข้อมูลเวลาเข้า-ออกงานจากเครื่องสแกนนิ้ว/ใบหน้า ZKTeco แบบ Real-time และบันทึกลงฐานข้อมูล SQL Server โดยอัตโนมัติ

## รายละเอียดการทำงาน

### 1. การเชื่อมต่อและดึงข้อมูล

- ดึงรายชื่อเครื่องสแกน (Device) จากฐานข้อมูลเพื่อเตรียมเชื่อมต่อ
- ใช้ระบบ **Live Capture** เพื่อดึงข้อมูลการสแกนทันทีที่มีเหตุการณ์เกิดขึ้น (ไม่ต้องรอ Pull ข้อมูล)
- รองรับการทำงานแบบ Multi-threading โดยแยก 1 Thread ต่อ 1 เครื่องสแกน

### 2. การจัดการรหัสพนักงาน (Employee ID)

- มีระบบ Normalize ID โดยจะเติมเลข 0 ด้านหน้าให้ครบ 5 หลักเสมอ (เช่น `5233` -> `05233`) เพื่อความสม่ำเสมอของข้อมูล

### 3. เงื่อนไขการบันทึกข้อมูล (Shift-based Logic)

ระบบจะตรวจสอบกะงานของพนักงานจากตาราง `[db_pfpdashboard].[dbo].[VListPeriodEmployee]` เพื่อเลือกว่าจะบันทึกเป็นเวลาเข้าหรือออกงาน:

1. **การค้นหากะงาน**:
   - ค้นหากะงานจาก `EmpId` และ `DatePeriod` (วันนี้และเมื่อวาน)
   - เลือกกะงานที่ช่วงเวลาครอบคลุมเวลาที่แสกนจริง (รองรับกะข้ามคืน)
   - **กรณีพิเศษ (วันหยุด)**: หากวันนั้นในฐานข้อมูลระบุว่าเป็นวันหยุด (`HoliDay = 1`) และไม่มีการระบุเวลากะ (`InTmp = 00:00`) ระบบจะไม่นำกะงานมาคิด แต่จะใช้ **การบันทึกตามเวลาสแกนจริง** (ตามข้อ 4) แทน เพื่อรองรับการทำงานในวันหยุดหรือ OT
   - **DateTimeStamp**: จะบันทึกตามวันที่ในกะงาน (`DatePeriod`) เพื่อใช้รวมกลุ่มข้อมูลในกะเดียวกัน

2. **การตัดสินใจ (กรณีแสกนครั้งแรกของกะ)**:
   - **กรณีปกติ**: หากแสกนในช่วงแรกของกะ (ไม่เกินครึ่งหนึ่งของเวลาคนเข้า-ออก) จะบันทึกเป็น **TimeIn**
   - **กรณีแสกนเข้าไม่ติด (Missed Check-In)**: หากแสกนครั้งแรกแต่เวลาเลยจุดกึ่งกลางกะไปแล้ว ระบบจะบันทึกเป็น **TimeOut** โดยเว้นว่างช่อง **TimeIn** ไว้

3. **เกณฑ์การตัดสินใจทั้งหมด (Upsert)**:

| กรณี                               | เงื่อนไข                                          | การดำเนินการ                                       |
| :--------------------------------- | :------------------------------------------------ | :------------------------------------------------- |
| **บันทึกเวลาเข้า (Scan In)**       | แสกนครั้งแรกของกะ และเวลาอยู่ช่วงครึ่งแรกของกะ    | **INSERT** (`TimeIn` = เวลาแสกน, `TimeOut` = NULL) |
| **บันทึกเวลาออก (Scan Out)**       | แสกนครั้งแรกของกะ แต่เวลาอยู่ช่วงครึ่งหลังของกะ   | **INSERT** (`TimeIn` = NULL, `TimeOut` = เวลาแสกน) |
| **บันทึกเวลาออก (ปกติ)**           | เคยแสกนเข้า (TimeIn) ในกะนี้ไว้แล้ว               | **UPDATE** `TimeOut` ในแถวเดิม                     |
| **แก้ไขเวลาออก (Update Last Out)** | มีการสแกนซ้ำภายใน 1 ชั่วโมงหลังจากสแกนออกล่าสุด   | **UPDATE** `TimeOut` ใหม่ทับเวลาเดิม               |
| **ป้องกันสแกนซ้ำ (Threshold)**     | มีการสแกนภายใน 1ชั่วโมงหลังจากบันทึกครั้งแรกของกะ | **IGNORE** ไม่บันทึกข้อมูล                         |

### 4. ระบบจัดการข้อมูลไม่สมบูรณ์ (Auto-Cleanup)

หากพนักงานแสกนเข้างานไว้แต่ **"ลืมแสกนออก"** ระบบจะทำงานดังนี้:

#### 4.1 เงื่อนไขการ Cleanup

| กรณี                 | เงื่อนไข                                                         | การดำเนินการ           |
| :------------------- | :--------------------------------------------------------------- | :--------------------- |
| **มีกะงาน**          | `TimeIn` ของ Record เก่าไม่อยู่ใน **Shift Window** ของกะปัจจุบัน | ทำ AUTO_CLEANUP        |
| **ไม่มีกะงาน**       | Record เก่าเกิน **16 ชั่วโมง**                                   | ทำ AUTO_CLEANUP        |
| **อยู่ในกะเดียวกัน** | `TimeIn` อยู่ใน Shift Window (4 ชม. ก่อนเข้า ถึง 8 ชม. หลังออก)  | **ไม่ทำ** AUTO_CLEANUP |

> **Shift Window** = `shift_start - 4 ชม.` ถึง `shift_end + 8 ชม.`
>
> ตัวอย่าง: กะ 08:00-17:00 → Window = 04:00-01:00(+1 วัน)

#### 4.2 ขั้นตอนการ Cleanup

1. ค้นหา Record ล่าสุดของพนักงาน
2. ตรวจสอบว่า `TimeIn` ของ Record นั้นอยู่ใน Shift Window ของกะปัจจุบันหรือไม่
3. หากไม่อยู่ (ไม่ใช่กะเดียวกัน) → ดึง **เวลาเลิกงานตามแผน (OutTmp)** มาบันทึก และระบุ IP เป็น `AUTO_CLEANUP`
4. จากนั้นดำเนินการบันทึกการแสกนใหม่ตามปกติ

#### 4.3 การ Override ค่า AUTO_CLEANUP

หาก Record ถูก AUTO_CLEANUP ไปแล้ว แต่พนักงาน**แสกนออกจริง**ภายหลัง:

- ระบบจะตรวจสอบ `IPStampOut`
- ถ้าเป็น `'AUTO_CLEANUP'` → อนุญาตให้ **เขียนทับ** ด้วยเวลาแสกนจริงได้
- ถ้า `TimeOut > เวลาแสกน` (เวลาออกเป็นอนาคต) → อนุญาตให้ **เขียนทับ** ได้เช่นกัน

| สถานะ TimeOut                         | เงื่อนไขเพิ่มเติม | ผลลัพธ์                       |
| :------------------------------------ | :---------------- | :---------------------------- |
| `NULL`                                | -                 | **UPDATE** ได้                |
| มีค่า + `IPStampOut = 'AUTO_CLEANUP'` | -                 | **UPDATE** ทับได้             |
| มีค่า + เป็นอนาคต (`TimeOut > ts`)    | -                 | **UPDATE** ทับได้             |
| มีค่า + ไม่เกิน 1 ชม.                 | `0 < diff < 3600` | **UPDATE** ได้ (แก้ไขเวลาออก) |
| มีค่า + เกิน 1 ชม.                    | -                 | **ไม่ UPDATE**                |
| มีค่า + เกิน 1 ชม.                    | -                 | **ไม่ UPDATE**                |

#### 4.4 Global Cleanup Background Worker

ระบบมี Worker Thread ที่ทำงานอยู่เบื้องหลังเพื่อตรวจสอบข้อมูลที่ค้างอยู่ในตาราง `TimeAttandanceLog` ทั้งหมด:

- **ความถี่ในการทำงาน**: ทุกๆ 1 ชั่วโมง
- **เกณฑ์การตรวจสอบ**: ค้นหา Record ที่ `TimeOut` เป็น NULL และเวลา `TimeIn` (หรือ `DateTimeStamp`) **เกิน 16 ชั่วโมง** จากเวลาปัจจุบัน
- **การดำเนินการ**: ทำการ Stamp `TimeOut` ให้อัตโนมัติ โดยอ้างอิงจากแผนงาน (Shift) หรือใช้เวลาเดียวกับ `TimeIn` หากไม่พบแผนงาน พร้อมระบุ IP เป็น `AUTO_CLEANUP`

### 6. ความเสถียรของการเชื่อมต่อ (Connection Reliability)

ระบบถูกออกแบบมาให้ทำงานได้อย่างต่อเนื่องยาวนาน (High Availability) โดยมีกลไกจัดการความผิดพลาดดังนี้:

- **Auto Reconnection**: หากการเชื่อมต่อระหว่างโปรแกรมกับเครื่องสแกนนิ้วหลุด (เช่น ปัญหาเน็ตเวิร์ก หรือเครื่องสแกนถูกปิด) ระบบจะพยายามเชื่อมต่อใหม่โดยอัตโนมัติในทุกๆ **30 วินาที**
- **Independent Threads**: การเชื่อมต่อของแต่ละเครื่องแยกจากกันอิสระ หากเครื่องหนึ่งหลุด เครื่องอื่นๆ จะยังคงทำงานได้ตามปกติ
- **Resource Cleanup**: ทุกครั้งที่เกิด Error หรือมีการเชื่อมต่อใหม่ ระบบจะทำการล้าง Connection เดิม (ทั้ง ZK และ SQL) เพื่อป้องกันปัญหา Resource Leak

## วิธีการใช้งาน

1. ตั้งค่า Environment Variables ในไฟล์ `.env` (Server, Database, User, Password)
2. ติดตั้ง Dependency: `pip install -r requirements.txt`
3. รันโปรแกรม: `python zkteco_listener.py`
